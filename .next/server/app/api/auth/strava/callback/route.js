"use strict";(()=>{var e={};e.id=237,e.ids=[237],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7003:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>m,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>u});var o=r(9303),n=r(8716),i=r(670),s=r(7070),c=r(1066),l=r(1105);let u="force-dynamic";async function d(e){try{let t=e.nextUrl.searchParams,r=t.get("code"),a=t.get("error");if(a)return s.NextResponse.redirect(new URL(`/?error=${encodeURIComponent(a)}`,e.url));if(!r)return s.NextResponse.redirect(new URL("/?error=Missing authorization code",e.url));let o=e.headers.get("host")||"localhost:3000",n=`https://${o}/api/auth/strava/callback`,i=await (0,l.p$)(r,n),{data:{session:u}}=await c.O.auth.getSession();if(!u?.user)return s.NextResponse.redirect(new URL("/?error=User not authenticated",e.url));let d=u.user.id,p=`${i.athlete.firstname||""} ${i.athlete.lastname||""}`.trim(),h=i.athlete.city||"",{error:v}=await c.O.from("profiles").upsert({id:d,strava_id:i.athlete.id.toString(),strava_access_token:i.access_token,strava_refresh_token:i.refresh_token,strava_token_expires_at:new Date(1e3*i.expires_at).toISOString(),full_name:p||u.user.email,city:h},{onConflict:"id"});if(v)return console.error("Failed to save Strava tokens:",v),s.NextResponse.redirect(new URL("/?error=Failed to save Strava connection",e.url));return s.NextResponse.redirect(new URL("/dashboard?strava_connected=true",e.url))}catch(t){return console.error("Strava callback error:",t),s.NextResponse.redirect(new URL("/?error=Authentication failed",e.url))}}let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/strava/callback/route",pathname:"/api/auth/strava/callback",filename:"route",bundlePath:"app/api/auth/strava/callback/route"},resolvedPagePath:"/workspaces/hlr/app/api/auth/strava/callback/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:v,serverHooks:f}=p,_="/api/auth/strava/callback/route";function m(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}},1105:(e,t,r)=>{r.d(t,{AD:()=>i,Wz:()=>o,p$:()=>n});let a="https://www.strava.com/api/v3/oauth/token";function o(e){let t=process.env.STRAVA_CLIENT_ID;if(!t)throw Error("STRAVA_CLIENT_ID not configured");let r=new URLSearchParams({client_id:t,redirect_uri:e,response_type:"code",scope:"activity:read_all",state:Math.random().toString(36).substring(7)});return`https://www.strava.com/oauth/authorize?${r.toString()}`}async function n(e,t){let r=process.env.STRAVA_CLIENT_ID,o=process.env.STRAVA_CLIENT_SECRET;if(!r||!o)throw Error("Strava credentials not configured");let n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,client_secret:o,code:e,grant_type:"authorization_code",redirect_uri:t})});if(!n.ok)throw Error(`Strava token exchange failed: ${n.statusText}`);return n.json()}async function i(e){let t=process.env.STRAVA_CLIENT_ID,r=process.env.STRAVA_CLIENT_SECRET;if(!t||!r)throw Error("Strava credentials not configured");let o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:t,client_secret:r,refresh_token:e,grant_type:"refresh_token"})});if(!o.ok)throw Error(`Strava token refresh failed: ${o.statusText}`);return o.json()}},1066:(e,t,r)=>{r.d(t,{O:()=>i});var a=r(5674);let o="https://jvnpxcwjfidrlqlfmuvl.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnB4Y3dqZmlkcmxxbGZtdXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODI3MTUsImV4cCI6MjA3OTk1ODcxNX0.9DQsgYHtU285oG2Twzr5mw71z4_5EiUDzry--bdf5lU";if(!o||!n)throw Error("Missing Supabase environment variables");let i=(0,a.eI)(o,n)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,674],()=>r(7003));module.exports=a})();