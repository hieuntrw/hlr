"use strict";(()=>{var e={};e.id=267,e.ids=[267],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7135:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>u,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>l});var n=r(9303),i=r(8716),o=r(670),s=r(7070),c=r(9191);let l="force-dynamic";async function d(e){let t=e.nextUrl,r=t.searchParams.get("userId"),a=Number(t.searchParams.get("month")||0),n=Number(t.searchParams.get("year")||0),i="1"===t.searchParams.get("run");if(!r||!a||!n)return s.NextResponse.json({error:"Usage: /api/debug/sync?userId=<uuid>&month=<1-12>&year=<YYYY>&run=1 (run=1 to execute)"},{status:400});let o="1"===process.env.ALLOW_DEBUG_SYNC;if(i&&!o)return s.NextResponse.json({error:"Debug sync disabled. Set ALLOW_DEBUG_SYNC=1 in .env.local to enable running this endpoint."},{status:403});try{if(!i)return s.NextResponse.json({ok:!0,message:"Dry-run mode. Add &run=1 to execute."});let e=await (0,c.I3)(r,a,n);return s.NextResponse.json({ok:!0,result:e})}catch(e){return s.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/debug/sync/route",pathname:"/api/debug/sync",filename:"route",bundlePath:"app/api/debug/sync/route"},resolvedPagePath:"/workspaces/hlr/app/api/debug/sync/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:h}=_,f="/api/debug/sync/route";function m(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},9191:(e,t,r)=>{r.d(t,{I3:()=>o,g8:()=>c});var a=r(1066),n=r(1105);async function i(e){let{data:t,error:r}=await a.O.from("profiles").select("strava_refresh_token, strava_access_token, strava_token_expires_at").eq("id",e).single();if(r)throw Error(`Failed to load profile: ${r.message}`);if(!t||!t.strava_refresh_token)return null;let i=Math.floor(Date.now()/1e3),o=Number(t.strava_token_expires_at)||0;if(o>i+60)return{access_token:t.strava_access_token,refresh_token:t.strava_refresh_token,expires_at:o};try{let r=await (0,n.AD)(t.strava_refresh_token),{error:i}=await a.O.from("profiles").update({strava_access_token:r.access_token,strava_refresh_token:r.refresh_token,strava_token_expires_at:r.expires_at}).eq("id",e);if(i)throw Error(`Failed to update profile tokens: ${i.message}`);return{access_token:r.access_token,refresh_token:r.refresh_token,expires_at:r.expires_at}}catch(e){throw Error(`Failed to refresh Strava token: ${e?.message||e}`)}}async function o(e,t,r){let n=new Date(Date.UTC(r,t-1,1)),o=new Date(Date.UTC(r,t,0)),c=n.toISOString().slice(0,10),l=o.toISOString().slice(0,10),{data:d,error:_}=await a.O.from("challenges").select("id, start_date, end_date, is_locked, min_pace_seconds, max_pace_seconds").gte("start_date",c).lte("start_date",l).limit(1);if(_)throw Error(`Failed to load challenge: ${_.message}`);let u=d&&d[0];if(!u)throw Error("No challenge found for the requested month/year");if(u.is_locked)throw Error("Challenge is locked and cannot be synced");let p=new Date(new Date(u.end_date).getTime()+864e6);if(new Date>p)throw Error("Sync window expired (more than 10 days after challenge end)");let{data:h,error:f}=await a.O.from("challenge_participants").select("id, target_km").eq("challenge_id",u.id).eq("user_id",e).single();if(f)throw Error(`Failed to load participant: ${f.message}`);if(!h)throw Error("User is not registered for the challenge");let m=await i(e);if(!m||!m.access_token)throw Error("User does not have a valid Strava connection");let g=m.access_token,v=Math.floor(n.getTime()/1e3),w=Math.floor(o.getTime()/1e3)+86400,k=1,y=[],S=u.min_pace_seconds??240,b=u.max_pace_seconds??720;for(;;){let e=`https://www.strava.com/api/v3/athlete/activities?after=${v}&before=${w}&page=${k}&per_page=200`,t=await fetch(e,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok){let e=await t.text();throw Error(`Strava activities fetch failed: ${t.status} ${e}`)}let r=await t.json();if(!Array.isArray(r)||0===r.length)break;let a=r.filter(e=>{var t,r;if("Run"!==e.type&&"Walk"!==e.type)return!1;let a=(t=e.distance,r=e.moving_time,!t||t<=0||!r||r<=0?null:Math.round(r/(t/1e3)));return null!==a&&(!!function(e,t=240,r=720){return e>=t&&e<=r}(a,S,b)||(console.warn(`[stravaService] Activity ${e.id} filtered out: pace ${a}s/km outside range [${S}-${b}]`),!1))});if(y=y.concat(a),r.length<200)break;k+=1}let I=Math.round(y.reduce((e,t)=>e+(t.distance||0),0)/1e3*100)/100,x=y.reduce((e,t)=>e+(t.moving_time||t.elapsed_time||0),0),E=y.length,T=I>0?Math.round(x/I):0,O=E>0?Math.round(y.reduce((e,t)=>e+(t.average_heartrate||0),0)/E*100)/100:null,A=E>0?Math.round(y.reduce((e,t)=>e+(t.average_cadence||0),0)/E*100)/100:null,M=Math.round(100*y.reduce((e,t)=>e+(t.total_elevation_gain||0),0))/100;for(let t of y){let r={strava_activity_id:t.id,user_id:e,challenge_participant_id:h.id,name:t.name,type:t.type||"Run",distance:t.distance||0,moving_time:t.moving_time||0,elapsed_time:t.elapsed_time||0,elevation_gain:t.total_elevation_gain||null,average_heartrate:t.average_heartrate||null,max_heartrate:t.max_heartrate||null,average_cadence:t.average_cadence||null,start_date:t.start_date,raw_json:t},{error:n}=await a.O.from("activities").upsert([r],{onConflict:"strava_activity_id"});n&&console.error(`[stravaService] Failed to insert activity ${t.id}:`,n)}let N={actual_km:I,avg_pace_seconds:T,total_activities:E,last_synced_at:new Date().toISOString()};h.target_km&&I>=Number(h.target_km)&&(N.status="completed");let{error:$}=await a.O.from("challenge_participants").update(N).eq("id",h.id);if($)throw Error(`Failed to update participant: ${$.message}`);return await s(e,y,u.id),{challengeId:u.id,participantId:h.id,totalKm:I,avgPaceSeconds:T,totalActivities:E,avgHeartrate:O,avgCadence:A,totalElevation:M}}async function s(e,t,r){if(!t||0===t.length)return;let{data:n,error:i}=await a.O.from("profiles").select("id, pb_hm_seconds, pb_fm_seconds, pb_hm_approved, pb_fm_approved").eq("id",e).single();if(i){console.error("[stravaService] Failed to load profile for PB check:",i);return}let o=n?.pb_hm_seconds??null,s=n?.pb_fm_seconds??null;for(let r of t.filter(e=>e.event_type||3===e.workout_type||e.flagged)){let t=(r.name||"").toUpperCase(),n=r.distance||0,i=r.moving_time||0,c=null;if(t.includes("HALF")||t.includes("HM")||t.includes("21")?c="HM":t.includes("MARATHON")||t.includes("FM")||t.includes("42")?c="FM":n>=2e4&&n<22e3?c="HM":n>=41e3&&n<43e3&&(c="FM"),!c){console.warn(`[stravaService] Race activity ${r.id} could not be classified (${t})`);continue}let l="HM"===c?o:s;if(!l||i<l){console.log(`[stravaService] New PB detected: ${c} = ${i}s (old: ${l}s)`);let t={},n="HM"===c?"pb_hm_approved":"pb_fm_approved";t["HM"===c?"pb_hm_seconds":"pb_fm_seconds"]=i,t[n]=!1;let{error:o}=await a.O.from("profiles").update(t).eq("id",e);o?console.error("[stravaService] Failed to update PB:",o):console.log(`[stravaService] Profile updated with pending ${c} PB`);let{error:s}=await a.O.from("pb_history").insert({user_id:e,distance:c,time_seconds:i,achieved_at:new Date(r.start_date||new Date).toISOString().slice(0,10),race_id:null});s&&console.error("[stravaService] Failed to insert pb_history:",s)}}}async function c(e){let t=new Date,r=t.getMonth()+1,n=t.getFullYear(),i=await o(e,r,n),{data:s,error:c}=await a.O.from("challenge_participants").select("id, target_km, actual_km").eq("id",i.participantId).single();if(c)return{...i,progressPercent:null};let l=Number(s.target_km)||0,d=Number(s.actual_km)||Number(i.totalKm)||0;return{...i,progressPercent:l>0?Math.round(d/l*100):0}}},1105:(e,t,r)=>{r.d(t,{AD:()=>o,Wz:()=>n,p$:()=>i});let a="https://www.strava.com/api/v3/oauth/token";function n(e){let t=process.env.STRAVA_CLIENT_ID;if(!t)throw Error("STRAVA_CLIENT_ID not configured");let r=new URLSearchParams({client_id:t,redirect_uri:e,response_type:"code",scope:"activity:read_all",state:Math.random().toString(36).substring(7)});return`https://www.strava.com/oauth/authorize?${r.toString()}`}async function i(e,t){let r=process.env.STRAVA_CLIENT_ID,n=process.env.STRAVA_CLIENT_SECRET;if(!r||!n)throw Error("Strava credentials not configured");let i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,client_secret:n,code:e,grant_type:"authorization_code",redirect_uri:t})});if(!i.ok)throw Error(`Strava token exchange failed: ${i.statusText}`);return i.json()}async function o(e){let t=process.env.STRAVA_CLIENT_ID,r=process.env.STRAVA_CLIENT_SECRET;if(!t||!r)throw Error("Strava credentials not configured");let n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:t,client_secret:r,refresh_token:e,grant_type:"refresh_token"})});if(!n.ok)throw Error(`Strava token refresh failed: ${n.statusText}`);return n.json()}},1066:(e,t,r)=>{r.d(t,{O:()=>o});var a=r(5674);let n="https://jvnpxcwjfidrlqlfmuvl.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnB4Y3dqZmlkcmxxbGZtdXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODI3MTUsImV4cCI6MjA3OTk1ODcxNX0.9DQsgYHtU285oG2Twzr5mw71z4_5EiUDzry--bdf5lU";if(!n||!i)throw Error("Missing Supabase environment variables");let o=(0,a.eI)(n,i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,674],()=>r(7135));module.exports=a})();