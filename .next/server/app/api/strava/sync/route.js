"use strict";(()=>{var e={};e.id=245,e.ids=[245],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},9542:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>g,requestAsyncStorage:()=>h,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{POST:()=>p,dynamic:()=>_});var n=r(9303),s=r(8716),i=r(670),o=r(344),c=r(1615),l=r(7070),d=r(9191);let _="force-dynamic";async function p(e){try{let e=(0,o.createRouteHandlerClient)({cookies:c.cookies}),{data:{session:t}}=await e.auth.getSession();if(!t||!t.user)return l.NextResponse.json({success:!1,error:"Unauthorized - User not authenticated"},{status:401});let r=t.user.id,a=await (0,d.g8)(r),n=a.totalKm??0,s=a.avgPaceSeconds??0,i=s?`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`:null;return l.NextResponse.json({success:!0,message:"Đồng bộ th\xe0nh c\xf4ng",data:{total_km:n,pace:i,avg_pace_seconds:s,total_activities:a.totalActivities??0,progress_percent:a.progressPercent??null}})}catch(t){console.error("Strava sync error:",t);let e=t?.message||String(t);return l.NextResponse.json({success:!1,error:e},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/strava/sync/route",pathname:"/api/strava/sync",filename:"route",bundlePath:"app/api/strava/sync/route"},resolvedPagePath:"/workspaces/hlr/app/api/strava/sync/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:m}=u,v="/api/strava/sync/route";function g(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},9191:(e,t,r)=>{r.d(t,{I3:()=>i,g8:()=>c});var a=r(1066),n=r(1105);async function s(e){let{data:t,error:r}=await a.O.from("profiles").select("strava_refresh_token, strava_access_token, strava_token_expires_at").eq("id",e).single();if(r)throw Error(`Failed to load profile: ${r.message}`);if(!t||!t.strava_refresh_token)return null;let s=Math.floor(Date.now()/1e3),i=Number(t.strava_token_expires_at)||0;if(i>s+60)return{access_token:t.strava_access_token,refresh_token:t.strava_refresh_token,expires_at:i};try{let r=await (0,n.AD)(t.strava_refresh_token),{error:s}=await a.O.from("profiles").update({strava_access_token:r.access_token,strava_refresh_token:r.refresh_token,strava_token_expires_at:r.expires_at}).eq("id",e);if(s)throw Error(`Failed to update profile tokens: ${s.message}`);return{access_token:r.access_token,refresh_token:r.refresh_token,expires_at:r.expires_at}}catch(e){throw Error(`Failed to refresh Strava token: ${e?.message||e}`)}}async function i(e,t,r){let n=new Date(Date.UTC(r,t-1,1)),i=new Date(Date.UTC(r,t,0)),c=n.toISOString().slice(0,10),l=i.toISOString().slice(0,10),{data:d,error:_}=await a.O.from("challenges").select("id, start_date, end_date, is_locked, min_pace_seconds, max_pace_seconds").gte("start_date",c).lte("start_date",l).limit(1);if(_)throw Error(`Failed to load challenge: ${_.message}`);let p=d&&d[0];if(!p)throw Error("No challenge found for the requested month/year");if(p.is_locked)throw Error("Challenge is locked and cannot be synced");let u=new Date(new Date(p.end_date).getTime()+864e6);if(new Date>u)throw Error("Sync window expired (more than 10 days after challenge end)");let{data:h,error:f}=await a.O.from("challenge_participants").select("id, target_km").eq("challenge_id",p.id).eq("user_id",e).single();if(f)throw Error(`Failed to load participant: ${f.message}`);if(!h)throw Error("User is not registered for the challenge");let m=await s(e);if(!m||!m.access_token)throw Error("User does not have a valid Strava connection");let v=m.access_token,g=Math.floor(n.getTime()/1e3),w=Math.floor(i.getTime()/1e3)+86400,k=1,y=[],S=p.min_pace_seconds??240,x=p.max_pace_seconds??720;for(;;){let e=`https://www.strava.com/api/v3/athlete/activities?after=${g}&before=${w}&page=${k}&per_page=200`,t=await fetch(e,{headers:{Authorization:`Bearer ${v}`}});if(!t.ok){let e=await t.text();throw Error(`Strava activities fetch failed: ${t.status} ${e}`)}let r=await t.json();if(!Array.isArray(r)||0===r.length)break;let a=r.filter(e=>{var t,r;if("Run"!==e.type&&"Walk"!==e.type)return!1;let a=(t=e.distance,r=e.moving_time,!t||t<=0||!r||r<=0?null:Math.round(r/(t/1e3)));return null!==a&&(!!function(e,t=240,r=720){return e>=t&&e<=r}(a,S,x)||(console.warn(`[stravaService] Activity ${e.id} filtered out: pace ${a}s/km outside range [${S}-${x}]`),!1))});if(y=y.concat(a),r.length<200)break;k+=1}let b=Math.round(y.reduce((e,t)=>e+(t.distance||0),0)/1e3*100)/100,I=y.reduce((e,t)=>e+(t.moving_time||t.elapsed_time||0),0),E=y.length,T=b>0?Math.round(I/b):0,M=E>0?Math.round(y.reduce((e,t)=>e+(t.average_heartrate||0),0)/E*100)/100:null,O=E>0?Math.round(y.reduce((e,t)=>e+(t.average_cadence||0),0)/E*100)/100:null,$=Math.round(100*y.reduce((e,t)=>e+(t.total_elevation_gain||0),0))/100;for(let t of y){let r={strava_activity_id:t.id,user_id:e,challenge_participant_id:h.id,name:t.name,type:t.type||"Run",distance:t.distance||0,moving_time:t.moving_time||0,elapsed_time:t.elapsed_time||0,elevation_gain:t.total_elevation_gain||null,average_heartrate:t.average_heartrate||null,max_heartrate:t.max_heartrate||null,average_cadence:t.average_cadence||null,start_date:t.start_date,raw_json:t},{error:n}=await a.O.from("activities").upsert([r],{onConflict:"strava_activity_id"});n&&console.error(`[stravaService] Failed to insert activity ${t.id}:`,n)}let A={actual_km:b,avg_pace_seconds:T,total_activities:E,last_synced_at:new Date().toISOString()};h.target_km&&b>=Number(h.target_km)&&(A.status="completed");let{error:C}=await a.O.from("challenge_participants").update(A).eq("id",h.id);if(C)throw Error(`Failed to update participant: ${C.message}`);return await o(e,y,p.id),{challengeId:p.id,participantId:h.id,totalKm:b,avgPaceSeconds:T,totalActivities:E,avgHeartrate:M,avgCadence:O,totalElevation:$}}async function o(e,t,r){if(!t||0===t.length)return;let{data:n,error:s}=await a.O.from("profiles").select("id, pb_hm_seconds, pb_fm_seconds, pb_hm_approved, pb_fm_approved").eq("id",e).single();if(s){console.error("[stravaService] Failed to load profile for PB check:",s);return}let i=n?.pb_hm_seconds??null,o=n?.pb_fm_seconds??null;for(let r of t.filter(e=>e.event_type||3===e.workout_type||e.flagged)){let t=(r.name||"").toUpperCase(),n=r.distance||0,s=r.moving_time||0,c=null;if(t.includes("HALF")||t.includes("HM")||t.includes("21")?c="HM":t.includes("MARATHON")||t.includes("FM")||t.includes("42")?c="FM":n>=2e4&&n<22e3?c="HM":n>=41e3&&n<43e3&&(c="FM"),!c){console.warn(`[stravaService] Race activity ${r.id} could not be classified (${t})`);continue}let l="HM"===c?i:o;if(!l||s<l){console.log(`[stravaService] New PB detected: ${c} = ${s}s (old: ${l}s)`);let t={},n="HM"===c?"pb_hm_approved":"pb_fm_approved";t["HM"===c?"pb_hm_seconds":"pb_fm_seconds"]=s,t[n]=!1;let{error:i}=await a.O.from("profiles").update(t).eq("id",e);i?console.error("[stravaService] Failed to update PB:",i):console.log(`[stravaService] Profile updated with pending ${c} PB`);let{error:o}=await a.O.from("pb_history").insert({user_id:e,distance:c,time_seconds:s,achieved_at:new Date(r.start_date||new Date).toISOString().slice(0,10),race_id:null});o&&console.error("[stravaService] Failed to insert pb_history:",o)}}}async function c(e){let t=new Date,r=t.getMonth()+1,n=t.getFullYear(),s=await i(e,r,n),{data:o,error:c}=await a.O.from("challenge_participants").select("id, target_km, actual_km").eq("id",s.participantId).single();if(c)return{...s,progressPercent:null};let l=Number(o.target_km)||0,d=Number(o.actual_km)||Number(s.totalKm)||0;return{...s,progressPercent:l>0?Math.round(d/l*100):0}}},1105:(e,t,r)=>{r.d(t,{AD:()=>i,Wz:()=>n,p$:()=>s});let a="https://www.strava.com/api/v3/oauth/token";function n(e){let t=process.env.STRAVA_CLIENT_ID;if(!t)throw Error("STRAVA_CLIENT_ID not configured");let r=new URLSearchParams({client_id:t,redirect_uri:e,response_type:"code",scope:"activity:read_all",state:Math.random().toString(36).substring(7)});return`https://www.strava.com/oauth/authorize?${r.toString()}`}async function s(e,t){let r=process.env.STRAVA_CLIENT_ID,n=process.env.STRAVA_CLIENT_SECRET;if(!r||!n)throw Error("Strava credentials not configured");let s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,client_secret:n,code:e,grant_type:"authorization_code",redirect_uri:t})});if(!s.ok)throw Error(`Strava token exchange failed: ${s.statusText}`);return s.json()}async function i(e){let t=process.env.STRAVA_CLIENT_ID,r=process.env.STRAVA_CLIENT_SECRET;if(!t||!r)throw Error("Strava credentials not configured");let n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:t,client_secret:r,refresh_token:e,grant_type:"refresh_token"})});if(!n.ok)throw Error(`Strava token refresh failed: ${n.statusText}`);return n.json()}},1066:(e,t,r)=>{r.d(t,{O:()=>i});var a=r(5674);let n="https://jvnpxcwjfidrlqlfmuvl.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnB4Y3dqZmlkcmxxbGZtdXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODI3MTUsImV4cCI6MjA3OTk1ODcxNX0.9DQsgYHtU285oG2Twzr5mw71z4_5EiUDzry--bdf5lU";if(!n||!s)throw Error("Missing Supabase environment variables");let i=(0,a.eI)(n,s)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,674,958],()=>r(9542));module.exports=a})();